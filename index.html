<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaZi AI Assistant - Four Pillars of Destiny</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .main-content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .ai-chat-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            height: fit-content;
            max-height: 90vh;
            position: sticky;
            top: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .chat-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .chat-header h3 {
            margin-bottom: 5px;
        }
        
        .chat-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
            min-height: 300px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 90%;
            animation: fadeIn 0.3s ease-in;
        }
        
        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            background: #f0f2f5;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .send-btn:hover {
            background: #5a6fd8;
        }
        
        .quick-questions {
            margin-bottom: 15px;
        }
        
        .quick-question {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .quick-question:hover {
            background: #667eea;
            color: white;
        }
        
        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .pillars-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .pillar {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pillar:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .pillar h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .stem-branch {
            margin: 8px 0;
        }
        
        .chinese {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .element {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
            color: white;
            font-weight: 600;
        }
        
        .wood { background: #4CAF50; }
        .fire { background: #F44336; }
        .earth { background: #FF9800; }
        .metal { background: #9E9E9E; }
        .water { background: #2196F3; }
        
        .analysis-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .element-strength {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            align-items: center;
        }
        
        .strength-bar {
            width: 200px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .compatibility-result {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .luck-period {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .forecast-day {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .rating {
            display: flex;
            gap: 3px;
        }
        
        .star {
            color: #ffd700;
            font-size: 18px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }
        
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .ai-suggestion {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-suggestion:hover {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            transform: translateY(-2px);
        }
        
        .typing-indicator {
            display: none;
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .pillars-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .ai-chat-panel {
                order: -1;
                position: relative;
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div style="position: absolute; top: 0; left: 0; right: 0; z-index: -1;">
        <div class="header">
            <h1>🔮 BaZi AI Assistant</h1>
            <p>Discover your destiny with AI-powered Chinese metaphysics</p>
        </div>
    </div>
    
    <div class="container">
        <div class="main-content">
            <div class="tabs" style="margin-top: 100px;">
                <div class="tab active" onclick="showTab('chart')">📊 Chart Generator</div>
                <div class="tab" onclick="showTab('elements')">🔥 Element Analysis</div>
                <div class="tab" onclick="showTab('compatibility')">💕 Compatibility</div>
                <div class="tab" onclick="showTab('luck')">🍀 Luck Periods</div>
                <div class="tab" onclick="showTab('forecast')">📅 Daily Forecast</div>
            </div>
            
            <!-- Chart Generator Tab -->
            <div id="chart" class="tab-content active">
                <h2>Four Pillars Chart Generator</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="birthDate" value="1990-01-01">
                    </div>
                    <div class="form-group">
                        <label>Birth Time</label>
                        <input type="time" id="birthTime" value="12:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <button class="btn" onclick="generateChart()">Generate BaZi Chart</button>
                
                <div id="chartResult"></div>
            </div>
            
            <!-- Element Analysis Tab -->
            <div id="elements" class="tab-content">
                <h2>Element Strength Analysis</h2>
                <p>Generate a chart first to see element analysis, or enter birth details:</p>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="elemBirthDate" value="1990-01-01">
                    </div>
                    <div class="form-group">
                        <label>Birth Time</label>
                        <input type="time" id="elemBirthTime" value="12:00">
                    </div>
                </div>
                <button class="btn" onclick="analyzeElements()">Analyze Elements</button>
                
                <div id="elementResult"></div>
            </div>
            
            <!-- Compatibility Tab -->
            <div id="compatibility" class="tab-content">
                <h2>Relationship Compatibility</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3>Person 1</h3>
                        <div class="form-group">
                            <label>Birth Date</label>
                            <input type="date" id="person1Date" value="1990-01-01">
                        </div>
                        <div class="form-group">
                            <label>Birth Time</label>
                            <input type="time" id="person1Time" value="12:00">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="person1Gender">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h3>Person 2</h3>
                        <div class="form-group">
                            <label>Birth Date</label>
                            <input type="date" id="person2Date" value="1992-06-01">
                        </div>
                        <div class="form-group">
                            <label>Birth Time</label>
                            <input type="time" id="person2Time" value="14:00">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="person2Gender">
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="checkCompatibility()">Check Compatibility</button>
                
                <div id="compatibilityResult"></div>
            </div>
            
            <!-- Luck Periods Tab -->
            <div id="luck" class="tab-content">
                <h2>Luck Period Calculator</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="luckBirthDate" value="1990-01-01">
                    </div>
                    <div class="form-group">
                        <label>Birth Time</label>
                        <input type="time" id="luckBirthTime" value="12:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="luckGender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <button class="btn" onclick="calculateLuck()">Calculate Luck Periods</button>
                
                <div id="luckResult"></div>
            </div>
            
            <!-- Forecast Tab -->
            <div id="forecast" class="tab-content">
                <h2>Daily & Monthly Forecast</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Your Birth Date</label>
                        <input type="date" id="forecastBirthDate" value="1990-01-01">
                    </div>
                    <div class="form-group">
                        <label>Your Birth Time</label>
                        <input type="time" id="forecastBirthTime" value="12:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Forecast Period</label>
                    <select id="forecastPeriod">
                        <option value="daily">Next 7 Days</option>
                        <option value="monthly">Next 6 Months</option>
                    </select>
                </div>
                <button class="btn" onclick="generateForecast()">Generate Forecast</button>
                
                <div id="forecastResult"></div>
            </div>
        </div>
        
        <!-- AI Chat Panel -->
        <div class="ai-chat-panel">
            <div class="chat-header">
                <h3>🤖 BaZi AI Assistant</h3>
                <p>Ask me anything about your chart!</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    👋 Hello! I'm your BaZi AI assistant. I can help you understand your Four Pillars chart, explain Chinese metaphysics concepts, and provide personalized insights.
                    
                    <div class="quick-questions">
                        <div class="quick-question" onclick="askQuickQuestion('What does my Day Master mean?')">What does my Day Master mean?</div>
                        <div class="quick-question" onclick="askQuickQuestion('How do the five elements work?')">How do the five elements work?</div>
                        <div class="quick-question" onclick="askQuickQuestion('What are favorable elements?')">What are favorable elements?</div>
                        <div class="quick-question" onclick="askQuickQuestion('Explain my personality traits')">Explain my personality traits</div>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                🤖 AI is thinking...
            </div>
            
            <div class="chat-input-area">
                <div style="display: flex; align-items: center;">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Ask about your BaZi chart..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BaZi calculation data (same as before)
        const HEAVENLY_STEMS = {
            0: {chinese: '甲', element: 'wood', yin_yang: 'yang'},
            1: {chinese: '乙', element: 'wood', yin_yang: 'yin'},
            2: {chinese: '丙', element: 'fire', yin_yang: 'yang'},
            3: {chinese: '丁', element: 'fire', yin_yang: 'yin'},
            4: {chinese: '戊', element: 'earth', yin_yang: 'yang'},
            5: {chinese: '己', element: 'earth', yin_yang: 'yin'},
            6: {chinese: '庚', element: 'metal', yin_yang: 'yang'},
            7: {chinese: '辛', element: 'metal', yin_yang: 'yin'},
            8: {chinese: '壬', element: 'water', yin_yang: 'yang'},
            9: {chinese: '癸', element: 'water', yin_yang: 'yin'}
        };

        const EARTHLY_BRANCHES = {
            0: {chinese: '子', element: 'water', animal: 'Rat'},
            1: {chinese: '丑', element: 'earth', animal: 'Ox'},
            2: {chinese: '寅', element: 'wood', animal: 'Tiger'},
            3: {chinese: '卯', element: 'wood', animal: 'Rabbit'},
            4: {chinese: '辰', element: 'earth', animal: 'Dragon'},
            5: {chinese: '巳', element: 'fire', animal: 'Snake'},
            6: {chinese: '午', element: 'fire', animal: 'Horse'},
            7: {chinese: '未', element: 'earth', animal: 'Goat'},
            8: {chinese: '申', element: 'metal', animal: 'Monkey'},
            9: {chinese: '酉', element: 'metal', animal: 'Rooster'},
            10: {chinese: '戌', element: 'earth', animal: 'Dog'},
            11: {chinese: '亥', element: 'water', animal: 'Pig'}
        };

        const ELEMENT_RELATIONS = {
            wood: {generates: 'fire', destroys: 'earth', generated_by: 'water', destroyed_by: 'metal'},
            fire: {generates: 'earth', destroys: 'metal', generated_by: 'wood', destroyed_by: 'water'},
            earth: {generates: 'metal', destroys: 'water', generated_by: 'fire', destroyed_by: 'wood'},
            metal: {generates: 'water', destroys: 'wood', generated_by: 'earth', destroyed_by: 'fire'},
            water: {generates: 'wood', destroys: 'fire', generated_by: 'metal', destroyed_by: 'earth'}
        };

        let currentChart = null;
        let chatHistory = [];

        // AI Knowledge Base
        const AI_KNOWLEDGE = {
            dayMaster: {
                wood: "Wood Day Master represents growth, creativity, and flexibility. Yang Wood (甲) people are like towering trees - ambitious, pioneering, and strong-willed. Yin Wood (乙) people are like grass or flowers - gentle, adaptable, and diplomatic.",
                fire: "Fire Day Master represents passion, energy, and illumination. Yang Fire (丙) people are like the sun - warm, charismatic, and natural leaders. Yin Fire (丁) people are like candlelight - refined, spiritual, and intuitive.",
                earth: "Earth Day Master represents stability, patience, and nurturing. Yang Earth (戊) people are like mountains - reliable, conservative, and strong foundations. Yin Earth (己) people are like fertile soil - supportive, detail-oriented, and caring.",
                metal: "Metal Day Master represents structure, precision, and justice. Yang Metal (庚) people are like swords - decisive, strong-willed, and direct. Yin Metal (辛) people are like jewelry - refined, elegant, and quality-focused.",
                water: "Water Day Master represents wisdom, adaptability, and flow. Yang Water (壬) people are like oceans - vast, resourceful, and communicative. Yin Water (癸) people are like dew - quiet, intuitive, and deep-thinking."
            },
            elements: {
                basics: "The Five Elements (Wu Xing) are the foundation of Chinese metaphysics. They represent different types of energy and how they interact: Wood grows and creates, Fire burns and transforms, Earth stabilizes and supports, Metal cuts and organizes, Water flows and adapts.",
                cycles: "There are two main cycles: Generation Cycle (Wood→Fire→Earth→Metal→Water→Wood) where each element nourishes the next, and Destruction Cycle (Wood destroys Earth, Earth destroys Water, Water destroys Fire, Fire destroys Metal, Metal destroys Wood).",
                balance: "A balanced chart has all five elements present in harmony. Imbalance occurs when some elements are too strong or too weak, which affects personality and life experiences."
            },
            pillars: {
                year: "Year Pillar represents your ancestral influences, early childhood (0-15), and how others perceive you. It's your 'outer self' and social image.",
                month: "Month Pillar represents your career, relationships, adult life (16-45), and your relationship with parents and siblings. It's your 'working self'.",
                day: "Day Pillar is most important - it represents your core self, marriage, and middle age (46-60). The Day Master (top of Day Pillar) is your true personality.",
                hour: "Hour Pillar represents your children, old age (60+), and your inner thoughts. It's your 'private self' and how you think when alone."
            }
        };

        // All original BaZi functions (keeping them the same)
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function calculateStemBranch(totalDays) {
            const stemIndex = (totalDays - 1) % 10;
            const branchIndex = (totalDays - 1) % 12;
            return {
                stem: HEAVENLY_STEMS[stemIndex],
                branch: EARTHLY_BRANCHES[branchIndex]
            };
        }

        function getDaysSinceEpoch(date) {
            const epoch = new Date(1900, 0, 31);
            const timeDiff = date.getTime() - epoch.getTime();
            return Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
        }

        function getHourBranch(hour) {
            const hourRanges = [23, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21];
            for (let i = 0; i < hourRanges.length; i++) {
                if (hour >= hourRanges[i] && hour < hourRanges[(i + 1) % 12] + (i === 11 ? 24 : 0)) {
                    return i;
                }
            }
            return 0;
        }

        function calculateBaZi(birthDate, birthTime) {
            const date = new Date(birthDate + 'T' + birthTime);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();

            const yearStemIndex = (year - 4) % 10;
            const yearBranchIndex = (year - 4) % 12;

            const monthStemIndex = (yearStemIndex * 2 + month) % 10;
            const monthBranchIndex = (month + 1) % 12;

            const daysSince = getDaysSinceEpoch(date);
            const dayPillar = calculateStemBranch(daysSince);

            const hourBranchIndex = getHourBranch(hour);
            const hourStemIndex = (dayPillar.stem.chinese.charCodeAt(0) % 10 * 2 + Math.floor(hour / 2)) % 10;

            return {
                year: {
                    stem: HEAVENLY_STEMS[yearStemIndex],
                    branch: EARTHLY_BRANCHES[yearBranchIndex]
                },
                month: {
                    stem: HEAVENLY_STEMS[monthStemIndex],
                    branch: EARTHLY_BRANCHES[monthBranchIndex]
                },
                day: dayPillar,
                hour: {
                    stem: HEAVENLY_STEMS[hourStemIndex],
                    branch: EARTHLY_BRANCHES[hourBranchIndex]
                }
            };
        }

        function generateChart() {
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            const gender = document.getElementById('gender').value;

            const chart = calculateBaZi(birthDate, birthTime);
            currentChart = chart;

            const resultDiv = document.getElementById('chartResult');
            resultDiv.innerHTML = `
                <div class="chart-container">
                    <h3>Your Four Pillars Chart</h3>
                    <div class="pillars-grid">
                        <div class="pillar" onclick="explainPillar('year')">
                            <h4>Year Pillar</h4>
                            <div class="stem-branch">
                                <div class="chinese">${chart.year.stem.chinese}</div>
                                <div class="element ${chart.year.stem.element}">${chart.year.stem.element.toUpperCase()}</div>
                            </div>
                            <div class="stem-branch">
                                <div class="chinese">${chart.year.branch.chinese}</div>
                                <div class="element ${chart.year.branch.element}">${chart.year.branch.element.toUpperCase()}</div>
                                <div style="font-size: 11px; margin-top: 5px;">${chart.year.branch.animal}</div>
                            </div>
                        </div>
                        <div class="pillar" onclick="explainPillar('month')">
                            <h4>Month Pillar</h4>
                            <div class="stem-branch">
                                <div class="chinese">${chart.month.stem.chinese}</div>
                                <div class="element ${chart.month.stem.element}">${chart.month.stem.element.toUpperCase()}</div>
                            </div>
                            <div class="stem-branch">
                                <div class="chinese">${chart.month.branch.chinese}</div>
                                <div class="element ${chart.month.branch.element}">${chart.month.branch.element.toUpperCase()}</div>
                                <div style="font-size: 11px; margin-top: 5px;">${chart.month.branch.animal}</div>
                            </div>
                        </div>
                        <div class="pillar" onclick="explainPillar('day')">
                            <h4>Day Pillar ⭐</h4>
                            <div class="stem-branch">
                                <div class="chinese">${chart.day.stem.chinese}</div>
                                <div class="element ${chart.day.stem.element}">${chart.day.stem.element.toUpperCase()}</div>
                            </div>
                            <div class="stem-branch">
                                <div class="chinese">${chart.day.branch.chinese}</div>
                                <div class="element ${chart.day.branch.element}">${chart.day.branch.element.toUpperCase()}</div>
                                <div style="font-size: 11px; margin-top: 5px;">${chart.day.branch.animal}</div>
                            </div>
                        </div>
                        <div class="pillar" onclick="explainPillar('hour')">
                            <h4>Hour Pillar</h4>
                            <div class="stem-branch">
                                <div class="chinese">${chart.hour.stem.chinese}</div>
                                <div class="element ${chart.hour.stem.element}">${chart.hour.stem.element.toUpperCase()}</div>
                            </div>
                            <div class="stem-branch">
                                <div class="chinese">${chart.hour.branch.chinese}</div>
                                <div class="element ${chart.hour.branch.element}">${chart.hour.branch.element.toUpperCase()}</div>
                                <div style="font-size: 11px; margin-top: 5px;">${chart.hour.branch.animal}</div>
                            </div>
                        </div>
                    </div>
                    ${generateBasicAnalysis(chart, gender)}
                    
                    <div class="ai-suggestion" onclick="askQuickQuestion('Explain my complete BaZi chart in detail')">
                        🤖 Click here to get AI analysis of your complete chart
                    </div>
                </div>
            `;

            // Auto-generate AI welcome message for new chart
            setTimeout(() => {
                addAIMessage(`🎉 Great! I can see your BaZi chart now. Your Day Master is ${chart.day.stem.chinese} (${chart.day.stem.element.toUpperCase()}). ${AI_KNOWLEDGE.dayMaster[chart.day.stem.element]} 

Click on any pillar above to learn more, or ask me specific questions about your chart!`);
            }, 1000);
        }

        function explainPillar(pillarType) {
            if (!currentChart) {
                addAIMessage("Please generate your BaZi chart first!");
                return;
            }
            
            const pillar = currentChart[pillarType];
            const message = `Tell me about my ${pillarType} pillar: ${pillar.stem.chinese}${pillar.branch.chinese}`;
            addUserMessage(message);
            
            setTimeout(() => {
                let response = `Your ${pillarType.toUpperCase()} PILLAR: ${pillar.stem.chinese}${pillar.branch.chinese}\n\n`;
                response += `${AI_KNOWLEDGE.pillars[pillarType]}\n\n`;
                response += `Your ${pillarType} pillar has:\n`;
                response += `• ${pillar.stem.chinese} (${pillar.stem.element.toUpperCase()} ${pillar.stem.yin_yang})\n`;
                response += `• ${pillar.branch.chinese} (${pillar.branch.element.toUpperCase()}) - ${pillar.branch.animal}\n\n`;
                
                if (pillarType === 'day') {
                    response += `⭐ This is your DAY MASTER - your core personality!\n`;
                    response += `${AI_KNOWLEDGE.dayMaster[pillar.stem.element]}`;
                }
                
                addAIMessage(response);
            }, 1000);
        }

        function generateBasicAnalysis(chart, gender) {
            const dayMaster = chart.day.stem;
            const elements = [
                chart.year.stem.element, chart.year.branch.element,
                chart.month.stem.element, chart.month.branch.element,
                chart.day.stem.element, chart.day.branch.element,
                chart.hour.stem.element, chart.hour.branch.element
            ];

            const elementCount = {};
            elements.forEach(elem => {
                elementCount[elem] = (elementCount[elem] || 0) + 1;
            });

            const strongElements = Object.keys(elementCount).filter(elem => elementCount[elem] >= 2);
            const weakElements = Object.keys(elementCount).filter(elem => elementCount[elem] === 1);

            return `
                <div class="analysis-section">
                    <h3>Basic Analysis</h3>
                    <p><strong>Day Master:</strong> ${dayMaster.chinese} (${dayMaster.element.toUpperCase()}) - This represents your core personality</p>
                    <p><strong>Strongest Elements:</strong> ${strongElements.map(e => e.toUpperCase()).join(', ')}</p>
                    <p><strong>Weakest Elements:</strong> ${weakElements.map(e => e.toUpperCase()).join(', ')}</p>
                    <p><strong>Personality Traits:</strong> ${getPersonalityTraits(dayMaster.element, dayMaster.yin_yang)}</p>
                </div>
            `;
        }

        function getPersonalityTraits(element, yinYang) {
            const traits = {
                wood: {
                    yang: "Creative, ambitious, pioneering, sometimes impatient",
                    yin: "Gentle, flexible, artistic, diplomatic"
                },
                fire: {
                    yang: "Energetic, charismatic, passionate, sometimes impulsive",
                    yin: "Warm, intuitive, spiritual, refined"
                },
                earth: {
                    yang: "Stable, reliable, practical, conservative",
                    yin: "Nurturing, patient, supportive, detail-oriented"
                },
                metal: {
                    yang: "Strong-willed, organized, decisive, justice-oriented",
                    yin: "Precise, elegant, perfectionist, quality-focused"
                },
                water: {
                    yang: "Adaptable, intelligent, resourceful, communicative",
                    yin: "Wise, intuitive, mysterious, deep-thinking"
                }
            };
            return traits[element][yinYang];
        }

        // AI Chat Functions
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            chatHistory.push({type: 'user', message: message});
        }

        function addAIMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            messageDiv.innerHTML = message.replace(/\n/g, '<br>');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            chatHistory.push({type: 'ai', message: message});
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.add('show');
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                const response = generateAIResponse(message);
                addAIMessage(response);
            }, 1000 + Math.random() * 1000);
        }

        function askQuickQuestion(question) {
            addUserMessage(question);
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                const response = generateAIResponse(question);
                addAIMessage(response);
            }, 1000);
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Chart-specific responses
            if (currentChart) {
                if (message.includes('day master')) {
                    const dayMaster = currentChart.day.stem;
                    return `Your Day Master is ${dayMaster.chinese} (${dayMaster.element.toUpperCase()} ${dayMaster.yin_yang}). ${AI_KNOWLEDGE.dayMaster[dayMaster.element]}

This means you tend to be ${getPersonalityTraits(dayMaster.element, dayMaster.yin_yang).toLowerCase()}. Your Day Master is the most important part of your chart as it represents your core self!`;
                }
                
                if (message.includes('personality') || message.includes('traits')) {
                    const dayMaster = currentChart.day.stem;
                    const analysis = calculateElementStrengths(currentChart);
                    return `Based on your ${dayMaster.element.toUpperCase()} Day Master, your core personality traits include: ${getPersonalityTraits(dayMaster.element, dayMaster.yin_yang)}.

Your strongest elements are: ${Object.keys(analysis.strengths).filter(elem => analysis.strengths[elem] >= 25).join(', ').toUpperCase()}

This combination suggests you're naturally ${dayMaster.element === 'wood' ? 'growth-oriented and creative' : dayMaster.element === 'fire' ? 'passionate and energetic' : dayMaster.element === 'earth' ? 'stable and reliable' : dayMaster.element === 'metal' ? 'organized and principled' : 'adaptable and wise'}.`;
                }
                
                if (message.includes('complete') || message.includes('detail')) {
                    return generateCompleteChartAnalysis();
                }
                
                if (message.includes('favorable') || message.includes('lucky')) {
                    const analysis = calculateElementStrengths(currentChart);
                    return `Your favorable elements are: ${analysis.favorable.join(', ').toUpperCase()}

These elements support and strengthen your energy. You should:
• Wear colors: ${getElementColors(analysis.favorable)}
• Face directions: ${getElementDirections(analysis.favorable)}
• Consider careers in: ${getElementCareers(analysis.favorable)}

Avoid overexposure to: ${analysis.unfavorable.join(', ').toUpperCase()} as these may drain your energy.`;
                }
            }
            
            // General BaZi knowledge
            if (message.includes('element') && message.includes('work')) {
                return AI_KNOWLEDGE.elements.basics + "\n\n" + AI_KNOWLEDGE.elements.cycles;
            }
            
            if (message.includes('pillar')) {
                return `The Four Pillars represent different life phases:

🗓️ YEAR PILLAR: ${AI_KNOWLEDGE.pillars.year}

🌙 MONTH PILLAR: ${AI_KNOWLEDGE.pillars.month}

☀️ DAY PILLAR: ${AI_KNOWLEDGE.pillars.day}

⏰ HOUR PILLAR: ${AI_KNOWLEDGE.pillars.hour}

The Day Pillar (especially Day Master) is most important for understanding your core personality!`;
            }
            
            if (message.includes('balance')) {
                return AI_KNOWLEDGE.elements.balance + "\n\nIn your chart, look for which elements are strongest/weakest. The goal is harmony, not necessarily equal amounts of each element.";
            }
            
            // Compatibility questions
            if (message.includes('compatibility') || message.includes('relationship')) {
                return `BaZi compatibility looks at how two people's charts interact:

🔥 ELEMENT HARMONY: How your Day Masters support or clash
🐲 ANIMAL COMPATIBILITY: Whether your zodiac animals are allies
⚖️ BALANCE: How you complement each other's strengths/weaknesses

Generate charts for both people in the Compatibility tab, and I'll give you detailed analysis!`;
            }
            
            // Career and life guidance
            if (message.includes('career') || message.includes('job')) {
                if (currentChart) {
                    const dayMaster = currentChart.day.stem.element;
                    return `Based on your ${dayMaster.toUpperCase()} Day Master, suitable careers include:

${getElementCareers([dayMaster])}

Your natural talents align with ${dayMaster === 'wood' ? 'growth, teaching, and healing fields' : dayMaster === 'fire' ? 'communication, entertainment, and leadership roles' : dayMaster === 'earth' ? 'service, real estate, and nurturing professions' : dayMaster === 'metal' ? 'finance, technology, and precision work' : 'research, transportation, and fluid industries'}.

Check your favorable elements for additional career directions!`;
                }
                return "Generate your BaZi chart first, then I can provide personalized career guidance based on your Day Master and element balance!";
            }
            
            // Default responses
            const defaultResponses = [
                "That's an interesting question! Could you be more specific about your BaZi chart? If you haven't generated one yet, please do so in the Chart Generator tab.",
                "I'd love to help! For the most accurate advice, I'll need to see your BaZi chart. Have you generated it yet?",
                "Great question! BaZi is a complex system. Could you clarify what specific aspect you'd like me to explain?",
                "I'm here to help with all things BaZi! Try asking about your Day Master, elements, compatibility, or luck periods.",
                "To give you the best personalized insights, please generate your BaZi chart first, then ask me about specific aspects!"
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        function generateCompleteChartAnalysis() {
            if (!currentChart) return "Please generate your chart first!";
            
            const dayMaster = currentChart.day.stem;
            const analysis = calculateElementStrengths(currentChart);
            
            return `🔮 COMPLETE BAZI ANALYSIS 🔮

📊 YOUR FOUR PILLARS:
Year: ${currentChart.year.stem.chinese}${currentChart.year.branch.chinese} (${currentChart.year.branch.animal})
Month: ${currentChart.month.stem.chinese}${currentChart.month.branch.chinese} (${currentChart.month.branch.animal})
Day: ${currentChart.day.stem.chinese}${currentChart.day.branch.chinese} (${currentChart.day.branch.animal}) ⭐
Hour: ${currentChart.hour.stem.chinese}${currentChart.hour.branch.chinese} (${currentChart.hour.branch.animal})

🎯 DAY MASTER: ${dayMaster.chinese} (${dayMaster.element.toUpperCase()})
${AI_KNOWLEDGE.dayMaster[dayMaster.element]}

🌟 ELEMENT BALANCE:
${Object.keys(analysis.strengths).map(elem => `${elem.toUpperCase()}: ${analysis.strengths[elem]}%`).join('\n')}

✅ FAVORABLE: ${analysis.favorable.join(', ').toUpperCase()}
❌ UNFAVORABLE: ${analysis.unfavorable.join(', ').toUpperCase()}

💡 RECOMMENDATIONS:
• Colors: ${getElementColors(analysis.favorable)}
• Directions: ${getElementDirections(analysis.favorable)}
• Careers: ${getElementCareers(analysis.favorable)}

Ask me specific questions about any aspect you'd like to explore deeper!`;
        }

        // Continue with existing BaZi functions...
        function analyzeElements() {
            const birthDate = document.getElementById('elemBirthDate').value;
            const birthTime = document.getElementById('elemBirthTime').value;
            
            const chart = calculateBaZi(birthDate, birthTime);
            currentChart = chart;
            const analysis = calculateElementStrengths(chart);
            
            const resultDiv = document.getElementById('elementResult');
            resultDiv.innerHTML = `
                <div class="analysis-section">
                    <h3>Element Strength Analysis</h3>
                    ${Object.keys(analysis.strengths).map(element => `
                        <div class="element-strength">
                            <span><strong>${element.toUpperCase()}:</strong></span>
                            <div class="strength-bar">
                                <div class="strength-fill ${element}" style="width: ${analysis.strengths[element]}%"></div>
                            </div>
                            <span>${analysis.strengths[element]}%</span>
                        </div>
                    `).join('')}
                </div>
                <div class="analysis-section">
                    <h3>Favorable & Unfavorable Elements</h3>
                    <div class="alert alert-success">
                        <strong>Favorable Elements:</strong> ${analysis.favorable.join(', ').toUpperCase()}
                        <br>These elements support and strengthen your energy.
                    </div>
                    <div class="alert alert-warning">
                        <strong>Unfavorable Elements:</strong> ${analysis.unfavorable.join(', ').toUpperCase()}
                        <br>These elements may create challenges or drain your energy.
                    </div>
                </div>
                <div class="analysis-section">
                    <h3>Recommendations</h3>
                    <p><strong>Colors to wear:</strong> ${getElementColors(analysis.favorable)}</p>
                    <p><strong>Best directions:</strong> ${getElementDirections(analysis.favorable)}</p>
                    <p><strong>Career fields:</strong> ${getElementCareers(analysis.favorable)}</p>
                </div>
                
                <div class="ai-suggestion" onclick="askQuickQuestion('Explain my element analysis in detail')">
                    🤖 Get detailed AI explanation of your element balance
                </div>
            `;
        }

        function calculateElementStrengths(chart) {
            const elements = [
                chart.year.stem.element, chart.year.branch.element,
                chart.month.stem.element, chart.month.branch.element,
                chart.day.stem.element, chart.day.branch.element,
                chart.hour.stem.element, chart.hour.branch.element
            ];

            const elementCount = {wood: 0, fire: 0, earth: 0, metal: 0, water: 0};
            elements.forEach(elem => elementCount[elem]++);

            const total = elements.length;
            const strengths = {};
            Object.keys(elementCount).forEach(elem => {
                strengths[elem] = Math.round((elementCount[elem] / total) * 100);
            });

            const dayMaster = chart.day.stem.element;
            const strongElements = Object.keys(elementCount).filter(elem => elementCount[elem] >= 2);
            const isDayMasterStrong = strongElements.includes(dayMaster);

            let favorable = [];
            let unfavorable = [];

            if (isDayMasterStrong) {
                favorable.push(ELEMENT_RELATIONS[dayMaster].generates);
                favorable.push(ELEMENT_RELATIONS[dayMaster].destroyed_by);
                unfavorable = strongElements.filter(elem => elem !== dayMaster);
            } else {
                favorable.push(ELEMENT_RELATIONS[dayMaster].generated_by);
                favorable.push(dayMaster);
                unfavorable.push(ELEMENT_RELATIONS[dayMaster].destroyed_by);
            }

            return {strengths, favorable: [...new Set(favorable)], unfavorable: [...new Set(unfavorable)]};
        }

        function getElementColors(elements) {
            const colors = {
                wood: 'Green, Light Blue',
                fire: 'Red, Orange, Pink',
                earth: 'Yellow, Brown, Beige',
                metal: 'White, Silver, Gold',
                water: 'Black, Dark Blue, Navy'
            };
            return elements.map(elem => colors[elem]).join(', ');
        }

        function getElementDirections(elements) {
            const directions = {
                wood: 'East, Southeast',
                fire: 'South',
                earth: 'Center, Southwest, Northeast',
                metal: 'West, Northwest',
                water: 'North'
            };
            return elements.map(elem => directions[elem]).join(', ');
        }

        function getElementCareers(elements) {
            const careers = {
                wood: 'Education, Health, Fashion, Forestry',
                fire: 'Entertainment, Marketing, Technology, Sports',
                earth: 'Real Estate, Agriculture, Construction, Hospitality',
                metal: 'Finance, Engineering, Military, Jewelry',
                water: 'Transportation, Communication, Research, Liquids'
            };
            return elements.map(elem => careers[elem]).join(', ');
        }

        // Rest of functions remain the same but with AI suggestions added...
        function checkCompatibility() {
            const person1Date = document.getElementById('person1Date').value;
            const person1Time = document.getElementById('person1Time').value;
            const person1Gender = document.getElementById('person1Gender').value;
            
            const person2Date = document.getElementById('person2Date').value;
            const person2Time = document.getElementById('person2Time').value;
            const person2Gender = document.getElementById('person2Gender').value;

            const chart1 = calculateBaZi(person1Date, person1Time);
            const chart2 = calculateBaZi(person2Date, person2Time);

            const compatibility = calculateCompatibility(chart1, chart2);

            const resultDiv = document.getElementById('compatibilityResult');
            resultDiv.innerHTML = `
                <div class="compatibility-result">
                    <h3>Compatibility Analysis</h3>
                    <div class="rating">
                        <strong>Overall Rating: </strong>
                        ${generateStarRating(compatibility.overall)}
                        <span>(${compatibility.overall}/5)</span>
                    </div>
                    <div class="analysis-section">
                        <h4>Element Harmony</h4>
                        <p>${compatibility.elementAnalysis}</p>
                        <div class="rating">
                            Element Compatibility: ${generateStarRating(compatibility.elementRating)}
                        </div>
                    </div>
                    <div class="analysis-section">
                        <h4>Animal Compatibility</h4>
                        <p>Person 1: ${chart1.year.branch.animal} | Person 2: ${chart2.year.branch.animal}</p>
                        <p>${compatibility.animalAnalysis}</p>
                        <div class="rating">
                            Animal Compatibility: ${generateStarRating(compatibility.animalRating)}
                        </div>
                    </div>
                    <div class="analysis-section">
                        <h4>Recommendations</h4>
                        <ul>
                            ${compatibility.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="ai-suggestion" onclick="askQuickQuestion('Give me detailed relationship advice based on our compatibility')">
                        🤖 Get personalized relationship advice from AI
                    </div>
                </div>
            `;
        }

        function calculateCompatibility(chart1, chart2) {
            const dayMaster1 = chart1.day.stem.element;
            const dayMaster2 = chart2.day.stem.element;
            const animal1 = chart1.year.branch.animal;
            const animal2 = chart2.year.branch.animal;

            let elementRating = 3;
            let elementAnalysis = '';
            
            if (ELEMENT_RELATIONS[dayMaster1].generates === dayMaster2) {
                elementRating = 5;
                elementAnalysis = `Excellent harmony! ${dayMaster1.toUpperCase()} generates ${dayMaster2.toUpperCase()}, creating a supportive dynamic.`;
            } else if (ELEMENT_RELATIONS[dayMaster2].generates === dayMaster1) {
                elementRating = 5;
                elementAnalysis = `Excellent harmony! ${dayMaster2.toUpperCase()} generates ${dayMaster1.toUpperCase()}, creating a supportive dynamic.`;
            } else if (ELEMENT_RELATIONS[dayMaster1].destroys === dayMaster2 || ELEMENT_RELATIONS[dayMaster2].destroys === dayMaster1) {
                elementRating = 2;
                elementAnalysis = `Challenging relationship. The elements are in conflict, requiring extra effort and understanding.`;
            } else if (dayMaster1 === dayMaster2) {
                elementRating = 4;
                elementAnalysis = `Same element partnership. You understand each other well but may lack complementary qualities.`;
            } else {
                elementRating = 3;
                elementAnalysis = `Neutral element relationship. Compatibility depends on other factors in your charts.`;
            }

            const animalCompatibility = {
                'Rat': ['Dragon', 'Monkey', 'Ox'],
                'Ox': ['Snake', 'Rooster', 'Rat'],
                'Tiger': ['Horse', 'Dog', 'Pig'],
                'Rabbit': ['Goat', 'Pig', 'Dog'],
                'Dragon': ['Rat', 'Monkey', 'Rooster'],
                'Snake': ['Ox', 'Rooster', 'Monkey'],
                'Horse': ['Tiger', 'Dog', 'Goat'],
                'Goat': ['Rabbit', 'Pig', 'Horse'],
                'Monkey': ['Rat', 'Dragon', 'Snake'],
                'Rooster': ['Ox', 'Snake', 'Dragon'],
                'Dog': ['Tiger', 'Horse', 'Rabbit'],
                'Pig': ['Rabbit', 'Goat', 'Tiger']
            };

            let animalRating = 3;
            let animalAnalysis = '';

            if (animalCompatibility[animal1]?.includes(animal2)) {
                animalRating = 5;
                animalAnalysis = `Excellent animal compatibility! ${animal1} and ${animal2} are natural allies.`;
            } else if (animal1 === animal2) {
                animalRating = 4;
                animalAnalysis = `Same animal signs. You share similar traits and understand each other well.`;
            } else {
                animalRating = 3;
                animalAnalysis = `Neutral animal compatibility. Focus on understanding each other's differences.`;
            }

            const overall = Math.round((elementRating + animalRating) / 2);

            const recommendations = [
                `Communicate openly about your different approaches to life`,
                `Respect each other's natural rhythms and energy cycles`,
                `Use favorable elements in your shared spaces: ${getSharedFavorableElements(chart1, chart2)}`,
                overall >= 4 ? `Your compatibility is strong - nurture this natural harmony` : `Work on patience and understanding - growth comes through challenges`
            ];

            return {
                overall,
                elementRating,
                elementAnalysis,
                animalRating,
                animalAnalysis,
                recommendations
            };
        }

        function getSharedFavorableElements(chart1, chart2) {
            const analysis1 = calculateElementStrengths(chart1);
            const analysis2 = calculateElementStrengths(chart2);
            const shared = analysis1.favorable.filter(elem => analysis2.favorable.includes(elem));
            return shared.length ? shared.join(', ').toUpperCase() : 'Focus on balance and harmony';
        }

        function generateStarRating(rating) {
            return '★'.repeat(rating) + '☆'.repeat(5 - rating);
        }

        function calculateLuck() {
            const birthDate = document.getElementById('luckBirthDate').value;
            const birthTime = document.getElementById('luckBirthTime').value;
            const gender = document.getElementById('luckGender').value;

            const chart = calculateBaZi(birthDate, birthTime);
            currentChart = chart;
            const luckPeriods = calculateLuckPeriods(chart, new Date(birthDate), gender);

            const resultDiv = document.getElementById('luckResult');
            resultDiv.innerHTML = `
                <div class="analysis-section">
                    <h3>10-Year Luck Periods</h3>
                    ${luckPeriods.tenYear.map(period => `
                        <div class="luck-period">
                            <h4>Age ${period.startAge} - ${period.endAge} (${period.startYear} - ${period.endYear})</h4>
                            <p><strong>Pillar:</strong> ${period.stem.chinese}${period.branch.chinese} (${period.stem.element.toUpperCase()} ${period.branch.element.toUpperCase()})</p>
                            <p><strong>Theme:</strong> ${period.theme}</p>
                            <p><strong>Key Areas:</strong> ${period.keyAreas}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="analysis-section">
                    <h3>Current Year Analysis (2025)</h3>
                    <div class="luck-period">
                        <h4>Year of the Wood Snake (乙巳)</h4>
                        <p><strong>Overall Energy:</strong> Transformation, wisdom, and strategic planning</p>
                        <p><strong>For You:</strong> ${getCurrentYearAnalysis(chart)}</p>
                    </div>
                </div>
                
                <div class="ai-suggestion" onclick="askQuickQuestion('Explain my current luck period and what to expect')">
                    🤖 Get AI insights about your current and upcoming luck periods
                </div>
            `;
        }

        function calculateLuckPeriods(chart, birthDate, gender) {
            const birthYear = birthDate.getFullYear();
            const currentYear = 2025;
            const currentAge = currentYear - birthYear;

            const periods = [];
            for (let i = 0; i < 8; i++) {
                const startAge = i * 10 + 5;
                const endAge = startAge + 9;
                const startYear = birthYear + startAge;
                const endYear = birthYear + endAge;

                const monthStem = chart.month.stem;
                const monthBranch = chart.month.branch;
                
                const stemIndex = (Object.keys(HEAVENLY_STEMS).find(key => HEAVENLY_STEMS[key].chinese === monthStem.chinese) + i + 1) % 10;
                const branchIndex = (Object.keys(EARTHLY_BRANCHES).find(key => EARTHLY_BRANCHES[key].chinese === monthBranch.chinese) + i + 1) % 12;

                const stem = HEAVENLY_STEMS[stemIndex];
                const branch = EARTHLY_BRANCHES[branchIndex];

                periods.push({
                    startAge,
                    endAge,
                    startYear,
                    endYear,
                    stem,
                    branch,
                    theme: getLuckTheme(stem.element, branch.element),
                    keyAreas: getLuckKeyAreas(stem.element, branch.element)
                });
            }

            return {
                tenYear: periods.filter(p => p.startYear <= currentYear + 50)
            };
        }

        function getLuckTheme(stemElement, branchElement) {
            const themes = {
                wood: 'Growth, creativity, new beginnings',
                fire: 'Recognition, passion, leadership',
                earth: 'Stability, patience, building foundations',
                metal: 'Structure, discipline, achievement',
                water: 'Wisdom, flexibility, spiritual growth'
            };
            return themes[stemElement] || 'Personal development';
        }

        function getLuckKeyAreas(stemElement, branchElement) {
            const areas = {
                wood: 'Career growth, education, health',
                fire: 'Public recognition, relationships, creativity',
                earth: 'Real estate, family, steady progress',
                metal: 'Business, investments, organization',
                water: 'Travel, spirituality, communication'
            };
            return areas[stemElement] || 'General life areas';
        }

        function getCurrentYearAnalysis(chart) {
            const dayMaster = chart.day.stem.element;
            const yearElement = 'wood'; // 2025 is Wood Snake year

            if (ELEMENT_RELATIONS[yearElement].generates === dayMaster) {
                return 'Favorable year for growth and expansion. Wood energy supports your development.';
            } else if (ELEMENT_RELATIONS[dayMaster].generates === yearElement) {
                return 'Year of giving and teaching. You may find yourself in leadership roles.';
            } else if (ELEMENT_RELATIONS[yearElement].destroys === dayMaster) {
                return 'Challenging year requiring patience. Focus on inner strength and adaptation.';
            } else {
                return 'Neutral year with balanced opportunities. Focus on steady progress.';
            }
        }

        function generateForecast() {
            const birthDate = document.getElementById('forecastBirthDate').value;
            const birthTime = document.getElementById('forecastBirthTime').value;
            const period = document.getElementById('forecastPeriod').value;

            const chart = calculateBaZi(birthDate, birthTime);
            currentChart = chart;
            const forecasts = period === 'daily' ? generateDailyForecast(chart) : generateMonthlyForecast(chart);

            const resultDiv = document.getElementById('forecastResult');
            resultDiv.innerHTML = `
                <div class="analysis-section">
                    <h3>${period === 'daily' ? 'Next 7 Days' : 'Next 6 Months'} Forecast</h3>
                    ${forecasts.map(forecast => `
                        <div class="forecast-day">
                            <div>
                                <strong>${forecast.date}</strong>
                                <div style="font-size: 14px; color: #666;">${forecast.pillar}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="rating">${generateStarRating(forecast.rating)}</div>
                                <div style="font-size: 14px; margin-top: 5px;">${forecast.advice}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="ai-suggestion" onclick="askQuickQuestion('What should I focus on this ${period === 'daily' ? 'week' : 'month'}?')">
                    🤖 Get AI advice for your ${period === 'daily' ? 'weekly' : 'monthly'} focus
                </div>
            `;
        }

        function generateDailyForecast(chart) {
            const forecasts = [];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dayPillar = calculateBaZi(date.toISOString().split('T')[0], '12:00').day;
                const dayMaster = chart.day.stem.element;
                const dayElement = dayPillar.stem.element;
                
                let rating = 3;
                let advice = 'Balanced day';
                
                if (ELEMENT_RELATIONS[dayElement].generates === dayMaster) {
                    rating = 5;
                    advice = 'Excellent day for new initiatives';
                } else if (ELEMENT_RELATIONS[dayMaster].generates === dayElement) {
                    rating = 4;
                    advice = 'Good day for helping others';
                } else if (ELEMENT_RELATIONS[dayElement].destroys === dayMaster) {
                    rating = 2;
                    advice = 'Exercise caution, rest if needed';
                } else if (dayElement === dayMaster) {
                    rating = 4;
                    advice = 'Strong personal energy day';
                }
                
                forecasts.push({
                    date: date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }),
                    pillar: `${dayPillar.stem.chinese}${dayPillar.branch.chinese}`,
                    rating,
                    advice
                });
            }
            
            return forecasts;
        }

        function generateMonthlyForecast(chart) {
            const forecasts = [];
            const today = new Date();
            
            for (let i = 0; i < 6; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const monthIndex = date.getMonth();
                const monthPillar = {
                    stem: HEAVENLY_STEMS[monthIndex % 10],
                    branch: EARTHLY_BRANCHES[(monthIndex + 2) % 12]
                };
                
                const dayMaster = chart.day.stem.element;
                const monthElement = monthPillar.stem.element;
                
                let rating = 3;
                let advice = 'Steady progress expected';
                
                if (ELEMENT_RELATIONS[monthElement].generates === dayMaster) {
                    rating = 5;
                    advice = 'Excellent month for growth and opportunities';
                } else if (ELEMENT_RELATIONS[dayMaster].generates === monthElement) {
                    rating = 4;
                    advice = 'Good month for leadership and giving';
                } else if (ELEMENT_RELATIONS[monthElement].destroys === dayMaster) {
                    rating = 2;
                    advice = 'Challenging month - focus on patience';
                }
                
                forecasts.push({
                    date: monthName,
                    pillar: `${monthPillar.stem.chinese}${monthPillar.branch.chinese}`,
                    rating,
                    advice
                });
            }
            
            return forecasts;
        }

        // Initialize chat with welcome message
        window.onload = function() {
            setTimeout(() => {
                addAIMessage(`🌟 Welcome to your BaZi AI Assistant! I'm here to help you understand Chinese metaphysics and your Four Pillars chart.

Here's what I can help you with:
• Generate and explain your BaZi chart
• Analyze your personality and elements  
• Check relationship compatibility
• Calculate luck periods and forecasts
• Answer any BaZi questions you have

Start by generating your chart in the Chart Generator tab, then come chat with me! 🔮`);
            }, 500);
        };
    </script>
</body>
</html>
